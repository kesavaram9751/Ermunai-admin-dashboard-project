<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Erumunai Admin — Firestore Live Dashboard</title>

    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
        crossorigin="anonymous" />

    <style>
        :root {
            --primary: #4a7c59;
            --accent: #f0ad4e;
            --bg: #f7f7f7;
            --white: #fff;
            --text: #333;
            --radius: 8px;
            --shadow: 0 2px 8px rgba(0, 0, 0, .1)
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0
        }

        body {
            font-family: Segoe UI, sans-serif;
            color: var(--text);
            background: var(--bg);
            display: flex;
            height: 100vh;
            overflow: hidden
        }

        a {
            text-decoration: none;
            color: inherit;
        }

        .sidebar {
            width: 250px;
            background: var(--primary);
            color: var(--white);
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 2rem 1rem;
        }

        .sidebar h2 {
            margin-bottom: 2rem;
            font-size: 1.25rem;
        }

        .nav {
            list-style: none;
            width: 100%;
        }

        .nav li+li {
            margin-top: 1rem;
        }

        .nav a {
            display: block;
            padding: 0.75rem 1rem;
            border-radius: var(--radius);
        }

        .nav a:hover,
        .nav a.active {
            background: var(--accent);
        }

        .main {
            flex: 1;
            display: flex;
            flex-direction: column;
        }

        header {
            background: var(--white);
            padding: 1rem 2rem;
            box-shadow: var(--shadow);
            display: flex;
            align-items: center;
            gap: 1rem;
            flex-wrap: wrap;
        }

        header .logo {
            height: 80px;
            width: auto;
        }

        header h1 {
            font-size: 1.5rem;
            color: var(--primary);
            flex-grow: 1;
        }

        .logout-btn {
            background: #ff5f5f;
            color: var(--white);
            border: none;
            padding: 8px 16px;
            border-radius: var(--radius);
            cursor: pointer;
            font-size: 0.95rem;
        }

        .logout-btn:hover {
            background: #e65050;
        }

        .content {
            padding: 2rem;
            overflow-y: auto
        }

        .card-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
            gap: 1.5rem;
            margin-bottom: 1.5rem
        }

        .card {
            background: var(--white);
            padding: 1.25rem;
            border-radius: var(--radius);
            box-shadow: var(--shadow)
        }

        .card .value {
            font-size: 1.8rem;
            color: var(--accent);
            font-weight: 700
        }

        table {
            width: 100%;
            border-collapse: collapse;
            background: var(--white);
            border-radius: var(--radius);
            box-shadow: var(--shadow);
            overflow: hidden
        }

        thead {
            background: var(--primary);
            color: var(--white)
        }

        th,
        td {
            padding: .75rem 1rem;
            text-align: left;
            border-bottom: 1px solid #eee
        }

        .grid-2x2 {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 1.5rem
        }

        @media(max-width:768px) {
            .grid-2x2 {
                grid-template-columns: 1fr
            }
        }
    </style>
</head>

<body>

    <aside class="sidebar">
        <h2>Erumunai Admin</h2>
        <ul class="nav">
            <li><a href="admin-dashboard.html" data-page="dashboard" class="active">Dashboard</a></li>
            <li><a href="dashboard-product-page.html" data-page="products">Product Details</a></li>
            <li><a href="dashboard-order-page.html" data-page="orders">Order Details</a></li>
            <li><a href="daashboard-setting.html" data-page="settings">Settings</a></li>
        </ul>
    </aside>

    <div class="main">
        <header>
            <img src="logo.jpg" alt="Erumunai Logo" class="logo" />
            <h1>Dashboard</h1>
            <button class="logout-btn" id="logoutBtn"><i class="fas fa-sign-out-alt"></i> Logout</button>
        </header>

        <div class="content">
            <div class="section-title" style="margin-bottom:1rem;color:var(--primary);font-size:1.25rem">Overview</div>

            <div id="summaryCards" class="card-grid"></div>

            <div class="grid-2x2">
                <div class="card chart-container"><canvas id="salesChart" height="140"></canvas></div>
                <div class="card chart-container"><canvas id="ordersChart" height="140"></canvas></div>

                <div class="card">
                    <div style="font-weight:700;margin-bottom:.75rem;color:var(--primary)">Best Selling Products</div>
                    <table>
                        <thead>
                            <tr>
                                <th>Product</th>
                                <th>Sold</th>
                                <th>Revenue(₹)</th>
                                <th>Stock</th>
                            </tr>
                        </thead>
                        <tbody id="productTable"></tbody>
                    </table>
                </div>

                <div class="card">
                    <div style="font-weight:700;margin-bottom:.75rem;color:var(--primary)">Recent Orders</div>
                    <table>
                        <thead>
                            <tr>
                                <th>Order ID</th>
                                <th>Customer</th>
                                <th>Status</th>
                                <th>Amount(₹)</th>
                            </tr>
                        </thead>
                        <tbody id="ordersTable"></tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- Firestore Integration -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
        import {
            getFirestore, collection, onSnapshot
        } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js";
        import { getAuth } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-auth.js";

        const firebaseConfig = {
            apiKey: "AIzaSyCbfdG2XU302FuZx0MapVTRmb3Qtaa-hA8",
            authDomain: "ermunai-e-commerce-project.firebaseapp.com",
            projectId: "ermunai-e-commerce-project",
            storageBucket: "ermunai-e-commerce-project.appspot.com",
            messagingSenderId: "365240050790",
            appId: "1:365240050790:web:2d4867d6ab4f93a661f9a7"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);

        const summaryContainer = document.getElementById("summaryCards");
        const productTable = document.getElementById("productTable");
        const ordersTable = document.getElementById("ordersTable");
        const salesCtx = document.getElementById("salesChart").getContext("2d");
        const ordersCtx = document.getElementById("ordersChart").getContext("2d");

        let salesChart = null;
        let ordersChart = null;

        const productsMap = new Map();

        function toDate(value) {
            if (!value) return null;
            if (typeof value.toDate === "function") return value.toDate();
            if (value.seconds) return new Date(value.seconds * 1000);
            return new Date(value);
        }

        function listenProducts() {
            onSnapshot(collection(db, "products"), snapshot => {
                productsMap.clear();
                snapshot.forEach(doc => {
                    const p = doc.data();
                    const key = p.name || doc.id;
                    productsMap.set(key, { id: doc.id, ...p });
                });
            });
        }

        function listenOrdersAndAggregate() {
            onSnapshot(collection(db, "orders"), snapshot => {
                const orders = [];
                snapshot.forEach(doc => orders.push({ id: doc.id, ...doc.data() }));

                const totalOrders = orders.length;
                let totalRevenue = 0;
                const monthlyRevenue = Array(12).fill(0);
                const monthlyOrders = Array(12).fill(0);
                const productAgg = new Map();

                orders.forEach(o => {
                    totalRevenue += parseFloat(o.amount) || 0;
                    const date = toDate(o.date) || new Date();
                    const m = date.getMonth();
                    monthlyOrders[m] += 1;
                    monthlyRevenue[m] += parseFloat(o.amount) || 0;

                    if (Array.isArray(o.items)) {
                        o.items.forEach(it => {
                            const name = (it.name || "").replace(/(^"+|"+$)/g, "") || "Unknown";
                            const qty = Number(it.quantity) || 1;
                            const productDoc = productsMap.get(name) || {};
                            const price = Number(productDoc.amount ?? productDoc.price ?? it.price ?? 0);
                            const revenue = price * qty;

                            const entry = productAgg.get(name) || { qty: 0, revenue: 0, stock: productDoc.stock ?? "—" };
                            entry.qty += qty;
                            entry.revenue += revenue;
                            entry.stock = productDoc.stock ?? entry.stock;
                            productAgg.set(name, entry);
                        });
                    }
                });

                // only 3 cards now
                renderSummary([
                    { label: "Total Revenue (₹)", value: totalRevenue.toFixed(0), sub: "" },
                    { label: "Total Orders", value: totalOrders, sub: "" },
                    { label: "Products", value: productsMap.size, sub: "" }
                ]);

                const labels = ["Jan", "Feb", "Mar", "Apr", "May", "Jun", "Jul", "Aug", "Sep", "Oct", "Nov", "Dec"];
                updateOrCreateChart(salesChart, salesCtx, 'line', labels, monthlyRevenue, 'Sales (₹)', chart => salesChart = chart);
                updateOrCreateChart(ordersChart, ordersCtx, 'bar', labels, monthlyOrders, 'Orders', chart => ordersChart = chart);

                const topProducts = Array.from(productAgg.entries())
                    .map(([name, v]) => ({
                        name,
                        sold: v.qty,
                        revenue: Math.round(v.revenue),
                        stock: v.stock
                    }))
                    .sort((a, b) => b.sold - a.sold)
                    .slice(0, 10);

                renderProductsTable(topProducts);

                orders.sort((a, b) => (toDate(b.date) || 0) - (toDate(a.date) || 0));
                renderRecentOrders(orders.slice(0, 6));
            });
        }

        function renderSummary(items) {
            summaryContainer.innerHTML = "";
            items.forEach(it => {
                const div = document.createElement("div");
                div.className = "card";
                div.innerHTML = `<div style="font-weight:600;margin-bottom:.4rem">${it.label}</div>
                     <div class="value">${it.value}</div>
                     <div style="color:#666;font-size:.85rem">${it.sub || ""}</div>`;
                summaryContainer.appendChild(div);
            });
        }

        function renderProductsTable(products) {
            productTable.innerHTML = "";
            if (!products || products.length === 0) {
                productTable.innerHTML = `<tr><td colspan="4">No sales data yet</td></tr>`;
                return;
            }
            products.forEach(p => {
                const tr = document.createElement("tr");
                tr.innerHTML = `<td>${p.name}</td><td>${p.sold}</td><td>${p.revenue}</td><td>${p.stock}</td>`;
                productTable.appendChild(tr);
            });
        }

        function renderRecentOrders(list) {
            ordersTable.innerHTML = "";
            if (!list || list.length === 0) {
                ordersTable.innerHTML = `<tr><td colspan="4">No recent orders</td></tr>`;
                return;
            }
            list.forEach(o => {
                const cust = o.customerName || o.customer || "—";
                const amount = Number(o.amount) ? Number(o.amount).toFixed(2) : o.amount || "0.00";
                const tr = document.createElement("tr");
                tr.innerHTML = `<td>${o.id}</td><td>${cust}</td><td>${o.status || "—"}</td><td>${amount}</td>`;
                ordersTable.appendChild(tr);
            });
        }

        function updateOrCreateChart(chartRef, ctx, type, labels, data, label, setter) {
            if (chartRef) {
                chartRef.data.labels = labels;
                chartRef.data.datasets[0].data = data;
                chartRef.update();
                return;
            }
            const cfg = {
                type,
                data: {
                    labels,
                    datasets: [{
                        label,
                        data,
                        fill: type === 'line',
                        borderColor: type === 'line' ? '#f0ad4e' : '#4a7c59',
                        backgroundColor: type === 'line' ? 'rgba(240,173,78,0.18)' : 'rgba(74,124,89,0.4)',
                        tension: 0.3
                    }]
                },
                options: { plugins: { legend: { display: false } }, scales: { y: { beginAtZero: true } } }
            };
            const ch = new Chart(ctx, cfg);
            setter && setter(ch);
        }

        listenProducts();
        listenOrdersAndAggregate();
    </script>

</body>
</html>
