<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Erumunai Organic Farm — Product Management</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <!-- Font Awesome -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />

  <style>
    :root {
      --primary: #4a7c59;
      --accent: #f0ad4e;
      --text: #333;
      --bg: #f7f7f7;
      --white: #fff;
      --radius: 8px;
      --transition: 0.3s ease;
      --shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
    }

    * { margin: 0; padding: 0; box-sizing: border-box; }

    body {
      font-family: "Segoe UI", sans-serif;
      background: var(--bg);
      color: var(--text);
      display: flex;
      height: 100vh;
      overflow: hidden;
    }

    a { text-decoration: none; color: inherit; }

    .sidebar {
      width: 250px;
      background: var(--primary);
      color: var(--white);
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: 2rem 1rem;
    }

    .sidebar h2 { margin-bottom: 2rem; font-size: 1.25rem; }

    .nav { list-style: none; width: 100%; }
    .nav li+li { margin-top: 1rem; }
    .nav a { display: block; padding: 0.75rem 1rem; border-radius: var(--radius); }
    .nav a:hover, .nav a.active { background: var(--accent); }

    .main { flex: 1; display: flex; flex-direction: column; }

    header {
      background: var(--white);
      padding: 1rem 2rem;
      box-shadow: var(--shadow);
      display: flex;
      align-items: center;
      gap: 1rem;
    }
    header h1 { flex-grow: 1; color: var(--primary); }

    .logout-btn {
      background: #ff5f5f;
      color: white;
      border: none;
      padding: 8px 16px;
      border-radius: var(--radius);
      cursor: pointer;
    }
    .logout-btn:hover { background: #e65050; }

    .content { padding: 2rem; overflow-y: auto; }
    .section-title { font-size: 1.5rem; margin-bottom: 1.5rem; color: var(--primary); }

    .filters { margin-bottom: 1rem; display:flex; gap:0.5rem; flex-wrap:wrap; }
    .filter-btn {
      background: var(--primary); color: white; border: none; padding: 0.5rem 1rem;
      border-radius: var(--radius); cursor: pointer;
    }
    .filter-btn.active, .filter-btn:hover { background: var(--accent); }

    .add-btn { background: var(--accent); color: white; border:none; padding:0.5rem 1rem; border-radius:var(--radius); cursor:pointer; margin-bottom:1rem; }

    .product-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(220px, max-content));
      gap: 1rem;
      justify-content: center;
    }

    .product-card {
      width: 220px; max-width:100%; background: var(--white); padding:1rem; border-radius:var(--radius);
      box-shadow: var(--shadow); text-align:center; transition: transform var(--transition);
    }
    .product-card.disabled { opacity:0.5; filter:grayscale(0.2); }

    .product-card img { width:100%; height:150px; object-fit:cover; border-radius:var(--radius); }
    .product-card h3 { margin:0.5rem 0; color:var(--primary); }

    .card-actions { display:flex; justify-content:center; gap:0.5rem; margin-top:0.5rem; }
    .card-actions button { background:none; border:none; cursor:pointer; font-size:1.1rem; padding:0.4rem; border-radius:6px; }
    .card-actions .edit-btn { color:var(--primary); }
    .card-actions .delete-btn { color:#e74c3c; }
    .card-actions button:hover { background:#f1f1f1; }

    .modal {
      display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.6);
      justify-content:center; align-items:center; padding:1rem;
    }

    /* modal: image left, form right */
    .modal-content {
      background: var(--white); padding: 1rem; border-radius: var(--radius);
      width: 800px; max-width: 100%; display:flex; gap:1rem; align-items:flex-start;
    }

    .modal-image { width:45%; }
    .modal-image img { width:100%; height:320px; object-fit:cover; border-radius:var(--radius); display:block; }

    .modal-form { width:55%; }
    .modal-form label { display:block; margin:0.5rem 0 0.25rem; }
    .modal-form input, .modal-form textarea, .modal-form select {
      width:100%; padding:0.5rem; border:1px solid #ccc; border-radius:var(--radius); margin-bottom:0.5rem;
    }

    .modal-actions { display:flex; justify-content:space-between; margin-top:0.5rem; }
    .save-btn, .cancel-btn { padding:0.5rem 1rem; border:none; border-radius:var(--radius); cursor:pointer; }
    .save-btn { background:var(--primary); color:white; } .cancel-btn { background:#ccc; }

    .small-muted { font-size:0.85rem; color:#666; }

    @media (max-width:720px) {
      .modal-content { flex-direction:column; width:100%; }
      .modal-image, .modal-form { width:100% }
      .modal-image img { height:200px; }
    }
  </style>
</head>

<body>
  <!-- Sidebar -->
  <aside class="sidebar">
    <h2>Ermunai Admin</h2>
    <ul class="nav">
      <li><a href="admin-dashboard.html" data-page="dashboard">Dashboard</a></li>
      <li><a href="dashboard-product-page.html" data-page="products" class="active">Product Details</a></li>
      <li><a href="dashboard-order-page.html" data-page="orders">Order Details</a></li>
      <li><a href="daashboard-setting.html" data-page="settings">Settings</a></li>
    </ul>
  </aside>

  <!-- Main -->
  <div class="main">
    <header>
      <h1>Product Management</h1>
      <button class="logout-btn"><i class="fas fa-sign-out-alt"></i> Logout</button>
    </header>

    <div class="content">
      <!-- Product Page -->
      <section id="products" class="page active">
        <div class="section-title">Manage Products</div>

        <!-- Filters -->
        <div class="filters">
          <button class="filter-btn active" data-category="all">All</button>
          <button class="filter-btn" data-category="readyToCookMixes">Ready-to-Cook Instant Mixes</button>
          <button class="filter-btn" data-category="instantSoup">Instant Soup Mix</button>
          <button class="filter-btn" data-category="idliPodi">Idli Podi's</button>
          <button class="filter-btn" data-category="instant">Ready to Serve</button>
          <button class="filter-btn" data-category="herbal">Herbal Products</button>
          <button class="filter-btn" data-category="disabled">Disabled</button>
        </div>

        <!-- Add Product -->
        <button id="addProductBtn" class="add-btn"><i class="fas fa-plus"></i> Add Product</button>

        <!-- Product Listing -->
        <div class="product-grid" id="productList"></div>
      </section>
    </div>
  </div>

  <!-- Add/Edit Product Modal -->
  <div class="modal" id="productModal">
    <div class="modal-content">

      <div class="modal-image">
        <label class="small-muted">Current Image (if any)</label>
        <img id="imagePreview" src="" alt="preview" style="display:none" />
        <div class="small-muted">Leave image input empty to keep existing image.</div>
        <div style="margin-top:0.5rem">
          <label>Upload Product Image</label>
          <input type="file" id="productImageFile" accept="image/*" />
        </div>
      </div>

      <div class="modal-form">
        <h2 id="modalTitle">Add Product</h2>
        <form id="productForm">
          <input type="hidden" id="productId" />

          <label>Name</label>
          <input type="text" id="productName" required />

          <label>Price (₹)</label>
          <input type="number" id="productPrice" required />

          <label>Discount (%)</label>
          <input type="number" id="productDiscount" />

          <label>Available Stock</label>
          <input type="number" id="productStock" required />

          <label>Description</label>
          <textarea id="productDescription" rows="4"></textarea>

          <label>Category</label>
          <select id="productCategory" required>
            <option value="readyToCookMixes">Ready-to-Cook Instant Mixes</option>
            <option value="instantSoup">Instant Soup Mix</option>
            <option value="idliPodi">Idli Podi's</option>
            <option value="instant">Ready to Serve</option>
            <option value="herbal">Herbal Products</option>
          </select>

          <label style="margin-top:0.5rem"><input type="checkbox" id="productDisabled" /> Disable product (hide from shop)</label>

          <div class="modal-actions">
            <button type="submit" class="save-btn">Save</button>
            <button type="button" id="closeModal" class="cancel-btn">Cancel</button>
          </div>
        </form>
      </div>

    </div>
  </div>

  <!-- Firebase + Supabase -->
  <script type="module">
    // Firebase
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getFirestore, collection, addDoc, getDocs, updateDoc, deleteDoc, doc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
    import { getAuth, signInWithEmailAndPassword, signOut, onAuthStateChanged, setPersistence, browserLocalPersistence } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

    // Supabase
    import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm";

    // ---------- CONFIG ----------
    const ADMIN_EMAIL = "ermunaiorganicfarm@gmail.com";
    const ADMIN_PASSWORD = "foods1125$"; // <-- keep or change for testing
    const firebaseConfig = {
      apiKey: "AIzaSyCbfdG2XU302FuZx0MapVTRmb3Qtaa-hA8",
      authDomain: "ermunai-e-commerce-project.firebaseapp.com",
      projectId: "ermunai-e-commerce-project",
      storageBucket: "ermunai-e-commerce-project.appspot.com",
      messagingSenderId: "365240050790",
      appId: "1:365240050790:web:2d4867d6ab4f93a661f9a7"
    };
    const SUPABASE_URL = "https://svbsrgxqgzuibrrsywix.supabase.co";
    const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InN2YnNyZ3hxZ3p1aWJycnN5d2l4Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTcxNjYwODIsImV4cCI6MjA3Mjc0MjA4Mn0.hlwbWVsEn7hNCuEn-u7pQL9B3d5IbfiMSSvbVAX2bx0"; // replace with your anon key

    // ---------- INIT ----------
    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const productRef = collection(db, "products");
    const auth = getAuth(app);
    const supabase = createClient(SUPABASE_URL, SUPABASE_KEY);

    // UI elements
    const productList = document.getElementById("productList");
    const productModal = document.getElementById("productModal");
    const closeModalBtn = document.getElementById("closeModal");
    const addProductBtn = document.getElementById("addProductBtn");
    const productForm = document.getElementById("productForm");
    const logoutBtn = document.querySelector(".logout-btn");
    const imagePreview = document.getElementById("imagePreview");
    const productImageFile = document.getElementById("productImageFile");

    let currentProductId = null;
    let isAdmin = false;
    let editingExistingImageUrl = "";

    // ---------- AUTH HELPERS ----------
    async function loginAdminIfPasswordProvided() {
      // Only skip auto-login if ADMIN_PASSWORD is falsy (empty/null)
      if (!ADMIN_PASSWORD) {
        console.warn("ADMIN_PASSWORD not set. Skipping auto-login. Use login form or set ADMIN_PASSWORD for testing.");
        return;
      }
      try {
        await setPersistence(auth, browserLocalPersistence);
        const cred = await signInWithEmailAndPassword(auth, ADMIN_EMAIL, ADMIN_PASSWORD);
        console.log("Auto-login success:", cred.user.email, "uid:", cred.user.uid);
      } catch (err) {
        console.error("Auto-login failed:", err);
      }
    }

    onAuthStateChanged(auth, (user) => {
      console.log("Auth state changed:", user);
      if (user && user.email === ADMIN_EMAIL) {
        isAdmin = true;
        console.log("✅ Signed in as admin:", user.email, "uid:", user.uid);
      } else {
        isAdmin = false;
      }
    });

    // Logout button
    logoutBtn.addEventListener("click", async () => {
      try {
        await signOut(auth);
        alert("Logged out");
        console.log("Signed out");
      } catch (e) {
        console.error("Sign out error:", e);
      }
    });

    // Run auto-login (only if ADMIN_PASSWORD set)
    loginAdminIfPasswordProvided();

    // ---------- UI behavior ----------
    addProductBtn.onclick = () => {
      currentProductId = null;
      editingExistingImageUrl = "";
      productForm.reset();
      imagePreview.style.display = "none";
      document.getElementById("modalTitle").textContent = "Add Product";
      productModal.style.display = "flex";
    };
    closeModalBtn.onclick = () => productModal.style.display = "none";

    // show preview when file selected
    productImageFile.addEventListener('change', (e) => {
      const f = e.target.files[0];
      if (f) {
        const url = URL.createObjectURL(f);
        imagePreview.src = url;
        imagePreview.style.display = 'block';
      } else if (editingExistingImageUrl) {
        imagePreview.src = editingExistingImageUrl;
        imagePreview.style.display = 'block';
      } else {
        imagePreview.style.display = 'none';
      }
    });

    // ---------- Save Product (keep previous image if not changed) ----------
    productForm.onsubmit = async (e) => {
      e.preventDefault();

      const user = auth.currentUser;
      if (!user) {
        alert("⚠️ Please login as admin to add products.");
        return;
      }
      if (user.email !== ADMIN_EMAIL) {
        alert("⚠️ You are logged in, but not as the admin account. Please login as: " + ADMIN_EMAIL);
        return;
      }

      // 1) Image handling
      const file = productImageFile.files[0];
      let imageUrl = editingExistingImageUrl || "";
      if (file) {
        try {
          const fileName = `products/${Date.now()}-${file.name}`;
          const { data, error } = await supabase.storage.from("ermunai-product-images").upload(fileName, file);
          if (error) {
            console.error("Supabase upload error:", error);
            alert("Upload failed: " + error.message);
            return;
          }
          const { data: publicUrl } = supabase.storage.from("ermunai-product-images").getPublicUrl(fileName);
          imageUrl = publicUrl.publicUrl;
        } catch (err) {
          console.error("Upload exception:", err);
          alert("Upload failed: " + err.message);
          return;
        }
      }

      // 2) Prepare product data
      const productData = {
        image: imageUrl,
        name: document.getElementById("productName").value,
        price: parseFloat(document.getElementById("productPrice").value),
        discount: parseFloat(document.getElementById("productDiscount").value) || 0,
        stock: parseInt(document.getElementById("productStock").value),
        description: document.getElementById("productDescription").value,
        category: document.getElementById("productCategory").value,
        disabled: document.getElementById("productDisabled").checked,
        updatedBy: user.uid,
        updatedAt: new Date().toISOString()
      };

      try {
        if (currentProductId) {
          const productDoc = doc(db, "products", currentProductId);
          await updateDoc(productDoc, productData);
        } else {
          productData.createdAt = new Date().toISOString();
          productData.createdBy = user.uid;
          await addDoc(productRef, productData);
        }
        productModal.style.display = "none";
        productImageFile.value = '';
        editingExistingImageUrl = "";
        loadProducts(getCurrentFilterCategory());
      } catch (err) {
        console.error("Firestore write failed:", err);
        alert("Firestore write failed: " + err.message + "\nSigned-in user: " + (user.email || user.uid));
      }
    };

    // ---------- Load products ----------
    async function loadProducts(category = "all") {
      productList.innerHTML = "";
      try {
        const snapshot = await getDocs(productRef);
        snapshot.forEach(docSnap => {
          const p = docSnap.data();

          const isDisabled = !!p.disabled;
          const matchesCategory = (category === 'all')
            || (category === 'disabled' && isDisabled)
            || (category !== 'disabled' && category !== 'all' && p.category === category)
            || (category === 'all');

          if (matchesCategory) {
            const card = document.createElement("div");
            card.className = 'product-card' + (isDisabled ? ' disabled' : '');
            card.innerHTML = `
              <img src="${p.image || 'https://via.placeholder.com/220x150?text=No+Image'}" alt="${p.name}" />
              <h3>${p.name}</h3>
              <p>₹${p.price} (${p.discount}% off)</p>
              <p>Stock: ${p.stock}</p>
              <div class="card-actions">
                <button class="edit-btn" title="Edit"><i class="fas fa-edit"></i></button>
                <button class="delete-btn" title="Delete"><i class="fas fa-trash"></i></button>
                <button class="toggle-btn" title="Toggle disable"><i class="fas fa-toggle-on"></i></button>
              </div>
            `;

            // Edit
            card.querySelector(".edit-btn").onclick = () => {
              currentProductId = docSnap.id;
              document.getElementById("modalTitle").textContent = "Edit Product";
              document.getElementById("productName").value = p.name || "";
              document.getElementById("productPrice").value = p.price || 0;
              document.getElementById("productDiscount").value = p.discount || 0;
              document.getElementById("productStock").value = p.stock || 0;
              document.getElementById("productDescription").value = p.description || "";
              document.getElementById("productCategory").value = p.category || 'readyToCookMixes';
              document.getElementById("productDisabled").checked = !!p.disabled;

              // show existing image preview and remember it
              editingExistingImageUrl = p.image || "";
              if (editingExistingImageUrl) {
                imagePreview.src = editingExistingImageUrl;
                imagePreview.style.display = 'block';
              } else {
                imagePreview.style.display = 'none';
              }

              // clear file input so it's empty unless user chooses new file
              productImageFile.value = '';

              productModal.style.display = "flex";
            };

            // Delete
            card.querySelector(".delete-btn").onclick = async () => {
              if (confirm(`Delete product "${p.name}"?`)) {
                await deleteDoc(doc(db, "products", docSnap.id));
                loadProducts(category);
              }
            };

            // Toggle disable (quick action)
            card.querySelector('.toggle-btn').onclick = async () => {
              try {
                const productDoc = doc(db, "products", docSnap.id);
                await updateDoc(productDoc, { disabled: !isDisabled, updatedAt: new Date().toISOString() });
                loadProducts(getCurrentFilterCategory());
              } catch (err) {
                console.error('Toggle disable failed:', err);
                alert('Failed to toggle disable: ' + err.message);
              }
            };

            productList.appendChild(card);
          }
        });
      } catch (err) {
        console.error("Failed to load products:", err);
        alert("Failed to load products: " + err.message);
      }
    }

    // filters
    function getCurrentFilterCategory() {
      const active = document.querySelector('.filter-btn.active');
      return active ? active.dataset.category : 'all';
    }

    document.querySelectorAll(".filter-btn").forEach(btn => {
      btn.onclick = () => {
        document.querySelectorAll(".filter-btn").forEach(b => b.classList.remove("active"));
        btn.classList.add("active");
        loadProducts(btn.dataset.category);
      };
    });

    // initial
    loadProducts();
  </script>
</body>
</html>
